# Multi-stage build: First stage builds mem0 base
FROM python:3.11-slim AS mem0-base

# Clone and build mem0 from source
RUN apt-get update && apt-get install -y git \
    && git clone https://github.com/mem0ai/mem0.git /app \
    && cd /app \
    && pip install --no-cache-dir -e .

# Second stage: Add PostgreSQL support
FROM mem0-base

# Install PostgreSQL client libraries and psycopg2
RUN apt-get update && apt-get install -y \
    libpq-dev \
    gcc \
    python3-dev \
    && pip install --no-cache-dir psycopg2-binary \
    && apt-get remove -y gcc python3-dev \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/*

# Create .mem0 directory and initialize SQLite database
RUN mkdir -p /app/.mem0 && \
    python3 -c "import sqlite3; conn = sqlite3.connect('/app/.mem0/history.db'); conn.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY)'); conn.commit(); conn.close()"

# Set working directory
WORKDIR /app
